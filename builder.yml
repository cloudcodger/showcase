---
- name: Create container for 'build' machine.
  gather_facts: false
  hosts: local_builder

  roles:
    - role: cloudcodger.proxmox_client.lxc

- name: Install 'libguestfs-tools' and update cloud init image files to contain the 'qemu-guest-agent'.
  hosts: builder

  roles:
    - role: cloudcodger.ubuntu.initial_apt_update

  tasks:
    - name: Install libguestfs-tools package.
      ansible.builtin.apt:
        name: libguestfs-tools
        cache_valid_time: 3600
        state: present

    - name: Download cloud-init image file.
      ansible.builtin.get_url:
        url: "{{ item.src }}"
        dest: "/root/{{ item.dest | basename }}.uncompressed"
      loop: "{{ images }}"
      when: item.src.startswith('http')

    - name: Copy cloud-init image file.
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "/root/{{ item.dest | basename }}.uncompressed"
      loop: "{{ images }}"
      when: not item.src.startswith('http')

    - name: Add 'acl' and 'qemu-guest-agent' to image file and update it.
      ansible.builtin.command: "virt-customize -a {{ item.dest | basename }}.uncompressed --install acl,qemu-guest-agent --update"
      loop: "{{ images }}"

    - name: Compress image file.
      ansible.builtin.command: "virt-sparsify --compress {{ item.dest | basename }}.uncompressed {{ item.dest | basename }}"
      loop: "{{ images }}"

    - name: Download the new image file.
      ansible.builtin.fetch:
        src: "/root/{{ item.dest | basename }}"
        dest: "{{ item.dest }}"
        flat: true
      loop: "{{ images }}"
